<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.charlie.web.oj.modular.data.similarity.mapper.TaskSimilarityMapper">

    <select id="selectSimilarityStats"
            resultType="io.charlie.web.oj.modular.data.similarity.dto.TaskReportStats">
        SELECT
        COUNT(*) as sampleCount,
        COUNT(DISTINCT similarity) as groupCount,
        MAX(similarity) as maxSimilarity,
        AVG(similarity) as avgSimilarity
        FROM task_similarity
        <where>
            <if test="taskId != null">
                AND task_id = #{taskId}
            </if>
            <if test="problemId != null">
                AND problem_id = #{problemId}
            </if>
            <if test="setId != null">
                AND set_id = #{setId}
            </if>
            <if test="isSet != null">
                AND is_set = #{isSet}
            </if>
        </where>
    </select>

    <!-- 相似度分布查询 - 返回数量数组 [0,0,1,2,5,6,5,4,8,1] -->
    <select id="selectSimilarityDistribution" resultType="java.lang.Integer">
    <![CDATA[
        WITH ranges AS (SELECT 0 as range_start, 10 as range_end, 1 as range_index
                        UNION ALL
                        SELECT 10, 20, 2
                        UNION ALL
                        SELECT 20, 30, 3
                        UNION ALL
                        SELECT 30, 40, 4
                        UNION ALL
                        SELECT 40, 50, 5
                        UNION ALL
                        SELECT 50, 60, 6
                        UNION ALL
                        SELECT 60, 70, 7
                        UNION ALL
                        SELECT 70, 80, 8
                        UNION ALL
                        SELECT 80, 90, 9
                        UNION ALL
                        SELECT 90, 100, 10)
        SELECT COALESCE(COUNT(ts.similarity), 0) as count
        FROM ranges r
            LEFT JOIN task_similarity ts
        ON
            ts.task_id = #{taskId}
            AND (ts.similarity * 100) >= r.range_start
            AND (ts.similarity * 100) < r.range_end
        GROUP BY r.range_index
        ORDER BY r.range_index
        ]]>
</select>

    <!-- 程度统计查询 -->
    <select id="selectDegreeStatistics" resultType="io.charlie.web.oj.modular.data.similarity.dto.CloneLevel">
    <![CDATA[
        WITH degree_categories AS (SELECT 'HIGHLY_SUSPECTED' as degree, 1 as sort_order
                                   UNION ALL
                                   SELECT 'MEDIUM_SUSPECTED', 2
                                   UNION ALL
                                   SELECT 'LOW_SUSPECTED', 3
                                   UNION ALL
                                   SELECT 'NOT_REACHED', 4),
             degree_stats AS (SELECT CASE
                                         WHEN similarity >= #{threshold} * 0.9 THEN 'HIGHLY_SUSPECTED'
                                         WHEN similarity >= #{threshold} * 0.7 THEN 'MEDIUM_SUSPECTED'
                                         WHEN similarity >= #{threshold} * 0.5 THEN 'LOW_SUSPECTED'
                                         WHEN similarity >= #{threshold} THEN 'NOT_REACHED'
                                         ELSE 'NOT_DETECTED'
                                         END as degree,
                                     COUNT(*) as count
        FROM task_similarity
        WHERE task_id = #{taskId}
        GROUP BY
            CASE
            WHEN similarity >= #{threshold} * 0.9 THEN 'HIGHLY_SUSPECTED'
            WHEN similarity >= #{threshold} * 0.7 THEN 'MEDIUM_SUSPECTED'
            WHEN similarity >= #{threshold} * 0.5 THEN 'LOW_SUSPECTED'
            WHEN similarity >= #{threshold} THEN 'NOT_REACHED'
            ELSE 'NOT_DETECTED'
        END
        ),
        total_stats AS (
            SELECT COUNT(*) as total_count
            FROM task_similarity
            WHERE task_id =
        #{taskId}
        )
        SELECT dc.degree as cloneLevel,
               CASE dc.degree
                   WHEN 'HIGHLY_SUSPECTED' THEN '高度可疑'
                   WHEN 'MEDIUM_SUSPECTED' THEN '中度可疑'
                   WHEN 'LOW_SUSPECTED' THEN '轻度可疑'
                   WHEN 'NOT_REACHED' THEN '未达阈值'
                   END   as cloneLevelName,
               NULL      as similarity,
               COALESCE(ds.count, 0) as count,
            CASE
                WHEN ts.total_count > 0 THEN
                    ROUND((COALESCE(ds.count, 0) * 100.0 / ts.total_count), 2)
                ELSE 0
        END
        as percentage
        FROM degree_categories dc
        LEFT JOIN degree_stats ds ON dc.degree = ds.degree
        CROSS JOIN total_stats ts
        ORDER BY dc.sort_order
        ]]>
</select>

    <select id="getDegreeBySimilarity" resultType="java.lang.String">
            <![CDATA[
        SELECT CASE
                   WHEN #{similarity} >= #{threshold} * 0.9 THEN 'HIGHLY_SUSPECTED'
                   WHEN #{similarity} >= #{threshold} * 0.7 THEN 'MEDIUM_SUSPECTED'
                   WHEN #{similarity} >= #{threshold} * 0.5 THEN 'LOW_SUSPECTED'
                   WHEN #{similarity} >= #{threshold} THEN 'NOT_REACHED'
                   ELSE 'NOT_DETECTED'
                   END as degree
        ]]>
    </select>
</mapper>
